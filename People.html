<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–£–º–Ω—ã–π –ø–æ–¥–±–æ—Ä –ª–æ—à–∞–¥–µ–π ‚Äî EquiMatch</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #333;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

.header {
  text-align: center;
  margin-bottom: 40px;
  color: white;
}

.header h1 {
  font-size: 2.5em;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.header p {
  font-size: 1.2em;
  opacity: 0.9;
}

.search-panel {
  background: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  margin-bottom: 30px;
}

.section {
  margin-bottom: 30px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
  border-left: 4px solid #667eea;
}

.section h3 {
  color: #495057;
  margin-bottom: 15px;
  font-size: 1.3em;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #495057;
  font-size: 0.95em;
}

.form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 16px;
  background: white;
  transition: all 0.3s ease;
}

.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.search-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.search-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.results {
  background: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.results h2 {
  color: #495057;
  margin-bottom: 20px;
  text-align: center;
}

.no-results {
  text-align: center;
  padding: 40px;
  color: #6c757d;
}

.no-results p {
  margin-bottom: 10px;
  font-size: 1.1em;
}

.horse-card {
  border: 2px solid #e9ecef;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  background: white;
  transition: all 0.3s ease;
}

.horse-card:hover {
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.horse-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e9ecef;
}

.horse-name {
  font-size: 1.4em;
  font-weight: 700;
  color: #495057;
}

.match-badge {
  padding: 8px 16px;
  border-radius: 20px;
  color: white;
  font-weight: 600;
  text-align: center;
  min-width: 120px;
}

.match-perfect {
  background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
}

.match-excellent {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.match-good {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.match-weak {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.horse-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.detail-group h4 {
  color: #6c757d;
  font-size: 0.9em;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.detail-group p {
  margin: 5px 0;
  font-size: 0.95em;
}

.loading {
  text-align: center;
  padding: 40px;
  font-size: 1.2em;
  color: #667eea;
}

.weight-indicator {
  font-size: 0.8em;
  color: #6c757d;
  font-weight: normal;
  margin-left: 5px;
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  .header h1 {
    font-size: 2em;
  }
  
  .search-panel, .results {
    padding: 20px;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .horse-header {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  .horse-details {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üèá –£–º–Ω—ã–π –ø–æ–¥–±–æ—Ä –ª–æ—à–∞–¥–µ–π</h1>
    <p>–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –ø–æ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</p>
  </div>

  <div class="search-panel">
    <form id="buyerForm">
      <div class="section">
        <h3>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ–ø—ã—Ç</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>–î–ª—è –∫–æ–≥–æ –∏—â–µ—Ç–µ –ª–æ—à–∞–¥—å <span class="weight-indicator">(–≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å)</span></label>
            <select id="self">
              <option value="self">–î–ª—è —Å–µ–±—è (self)</option>
              <option value="child">–î–ª—è —Ä–µ–±—ë–Ω–∫–∞ (child)</option>
              <option value="student">–î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ (student)</option>
            </select>
          </div>

          <div class="form-group">
            <label>–í–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—å <span class="weight-indicator">(–≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç)</span></label>
            <select id="inner_role">
              <option value="intuitive">–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Ç–Ω—ë—Ä</option>
              <option value="creator">–°–æ–∑–¥–∞—Ç–µ–ª—å</option>
              <option value="warrior">–í–æ–∏–Ω</option>
              <option value="mentor">–ù–∞—Å—Ç–∞–≤–Ω–∏–∫</option>
              <option value="explorer">–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å</option>
              <option value="listener">–°–ª—É—à–∞—Ç–µ–ª—å</option>
            </select>
          </div>

          <div class="form-group">
            <label>–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ <span class="weight-indicator">(—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)</span></label>
            <select id="experience_level">
              <option value="1">1 - –ù–∞—á–∏–Ω–∞—é—â–∏–π (beginner)</option>
              <option value="2">2 - –£–≤–µ—Ä–µ–Ω–Ω—ã–π –Ω–æ–≤–∏—á–æ–∫ (novice)</option>
              <option value="3">3 - –û–ø—ã—Ç–Ω—ã–π (intermediate)</option>
              <option value="4">4 - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª (professional)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üéØ –¶–µ–ª–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ <span class="weight-indicator">(–≤–µ—Å: 70%)</span></label>
            <select id="preferred_discipline">
              <option value="dressage">–í—ã–µ–∑–¥–∫–∞ (Dressage)</option>
              <option value="jumping">–ü—Ä—ã–∂–∫–∏ (Jumping)</option>
              <option value="eventing">–¢—Ä–æ–µ–±–æ—Ä—å–µ (Eventing)</option>
              <option value="liberty">–õ–∏–±–µ—Ä—Ç–∏ (Liberty)</option>
              <option value="hobby / allround">–•–æ–±–±–∏/—É–Ω–∏–≤–µ—Ä—Å–∞–ª (Hobby/Allround)</option>
              <option value="groundwork">–†–∞–±–æ—Ç–∞ —Å –∑–µ–º–ª–∏ (Groundwork)</option>
              <option value="other">–î—Ä—É–≥–æ–µ (Other)</option>
            </select>
          </div>

          <div class="form-group">
            <label>–°—Ç–∏–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è <span class="weight-indicator">(–≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)</span></label>
            <select id="interaction_style">
              <option value="calm_trust">–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –¥–æ–≤–µ—Ä–∏–µ</option>
              <option value="structured">–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
              <option value="competitive">–°–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π</option>
              <option value="emotional">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
            </select>
          </div>

          <div class="form-group">
            <label>–¶–µ–ª—å –ø–æ–∫—É–ø–∫–∏ <span class="weight-indicator">(–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)</span></label>
            <select id="purchase_goal">
              <option value="hobby">–•–æ–±–±–∏ –∏ –æ—Ç–¥—ã—Ö</option>
              <option value="training">–û–±—É—á–µ–Ω–∏–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</option>
              <option value="sport">–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—å–µ—Ä–∞</option>
              <option value="investment">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>üí∞ –ë—é–¥–∂–µ—Ç –∏ –≤–Ω–µ—à–Ω–æ—Å—Ç—å</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>–ë—é–¥–∂–µ—Ç <span class="weight-indicator">(–≤–µ—Å: 80%, —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)</span></label>
            <select id="budget">
              <option value="<10k">–¥–æ 10,000 ‚Ç¨</option>
              <option value="10-20k">10,000 - 20,000 ‚Ç¨</option>
              <option value="20-35k">20,000 - 35,000 ‚Ç¨</option>
              <option value="35-50k">35,000 - 50,000 ‚Ç¨</option>
              <option value="50-70k">50,000 - 70,000 ‚Ç¨</option>
              <option value="70-100k">70,000 - 100,000 ‚Ç¨</option>
              <option value="100k+">—Å–≤—ã—à–µ 100,000 ‚Ç¨</option>
            </select>
          </div>

          <div class="form-group">
            <label>–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π —Ü–≤–µ—Ç <span class="weight-indicator">(–≤–µ—Å: 10%)</span></label>
            <select id="horse_color">
              <option value="any">–õ—é–±–æ–π —Ü–≤–µ—Ç</option>
              <option value="black">–í–æ—Ä–æ–Ω–∞—è (Black)</option>
              <option value="bay">–ì–Ω–µ–¥–∞—è (Bay)</option>
              <option value="chestnut">–†—ã–∂–∞—è (Chestnut)</option>
              <option value="grey">–°–µ—Ä–∞—è (Grey)</option>
              <option value="pinto">–ü–µ–≥–∞—è (Pinto)</option>
              <option value="buckskin">–ë—É–ª–∞–Ω–∞—è (Buckskin)</option>
              <option value="cremello">–ö—Ä–µ–º–æ–≤–∞—è (Cremello)</option>
              <option value="palomino">–ü–∞–ª–æ–º–∏–Ω–æ (Palomino)</option>
              <option value="roan">–ß–∞–ª–∞—è (Roan)</option>
              <option value="other">–î—Ä—É–≥–∞—è (Other)</option>
            </select>
          </div>
        </div>
      </div>

      <button type="submit" class="search-button" id="searchBtn">
        üîç –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ª–æ—à–∞–¥–µ–π
      </button>
    </form>
  </div>

  <div class="results" id="results">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–¥–±–æ—Ä–∞</h2>
    <div class="no-results">
      <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ª–æ—à–∞–¥–µ–π"</p>
      <p>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ–ª–µ–µ 15 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDiQkG24sfV4HivK8mvlOivQ9EblzUdJVY",
  authDomain: "equimach2.firebaseapp.com",
  projectId: "equimach2",
  storageBucket: "equimach2.firebasestorage.app",
  messagingSenderId: "491896102852",
  appId: "1:491896102852:web:78438246ce6737e3f1ce91"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// –°–∏—Å—Ç–µ–º–∞ –≤–µ—Å–æ–≤
const weights = {
  horse_age: 70,
  horse_height: 40, 
  horse_sex: 10,
  breed_type: 25,
  budget: 80,
  primary_discipline: 70,
  training_level: 100,
  temperament_boldness: 60,
  sensitivity_level: 60,
  pressure_response: 55,
  reliability: 70,
  human_contact: 50,
  social_behavior: 30,
  jumping_ability: 60,
  dressage_relevance: 60,
  vet_status: 80,
  coat_color: 10
};

// –ú–∞—Ç—Ä–∏—Ü—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
const compatibilityMatrices = {
  // üß© 3.1. –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—ã—Ç–∞
  checkExperienceCompatibility(buyerExp, horseTraining) {
    const experienceMap = {
      "1": ["green", "basic", "novice"],
      "2": ["green", "basic", "novice", "amateur"],
      "3": ["basic", "novice", "amateur", "competition"],
      "4": ["green", "basic", "novice", "amateur", "competition", "FEI"]
    };
    return experienceMap[buyerExp]?.includes(horseTraining) ?? true;
  },

  // üß© 3.2. –ë—é–¥–∂–µ—Ç (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
  checkBudgetCompatibility(buyerBudget, horseBudget) {
    const budgetOrder = ["<10k", "10-20k", "20-35k", "35-50k", "50-70k", "70-100k", "100k+"];
    if (!buyerBudget || !horseBudget) return true;
    const buyerIndex = budgetOrder.indexOf(buyerBudget);
    const horseIndex = budgetOrder.indexOf(horseBudget);
    return horseIndex <= buyerIndex;
  },

  // üß© 3.2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è target_subject
  calculateTargetSubjectModifiers(targetSubject, horse) {
    const modifiers = {
      reliability: 1.0,
      sensitivity_level: 1.0,
      temperament_boldness: 1.0
    };

    if (targetSubject === 'child') {
      if (horse.reliability === 'very_reliable') modifiers.reliability = 1.0;
      else if (horse.reliability === 'mostly_predictable') modifiers.reliability = 0.7;
      else modifiers.reliability = 0.0;

      if (['shy', 'medium'].includes(horse.temperament_boldness)) {
        modifiers.temperament_boldness = 1.0;
      } else {
        modifiers.temperament_boldness = 0.6;
      }

      if (horse.sensitivity_level === 'steady') modifiers.sensitivity_level = 1.0;
      else modifiers.sensitivity_level = 0.4;

    } else if (targetSubject === 'student') {
      if (horse.reliability === 'unpredictable') modifiers.reliability = 0.0;
    }

    return modifiers;
  },

  // üß© 3.3. –°—Ç–∏–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  getInteractionStyleMatch(interactionStyle, horse) {
    const styleProfiles = {
      'calm_trust': {
        preferred: ['steady', 'moderate', 'very_reliable', 'seeks_contact'],
        weights: [0.3, 0.2, 0.3, 0.2]
      },
      'structured': {
        preferred: ['reacts_softly', 'balanced', 'predictable', 'consistent'],
        weights: [0.25, 0.25, 0.25, 0.25]
      },
      'competitive': {
        preferred: ['bold', 'forward', 'high', 'elite', 'competition'],
        weights: [0.2, 0.2, 0.2, 0.2, 0.2]
      },
      'emotional': {
        preferred: ['sensitive', 'seeks_contact', 'intuitive', 'responsive'],
        weights: [0.3, 0.2, 0.3, 0.2]
      }
    };

    const profile = styleProfiles[interactionStyle];
    if (!profile) return 1.0;

    let matchScore = 0;
    profile.preferred.forEach((trait, index) => {
      if (Object.values(horse).includes(trait)) {
        matchScore += profile.weights[index];
      }
    });

    return Math.min(matchScore * 1.3, 1.0);
  },

  // üß© 3.7. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω
  disciplineMatch(buyerDiscipline, horseDiscipline) {
    const disciplineGroups = {
      'dressage': ['dressage', 'hobby / allround', 'liberty'],
      'jumping': ['jumping', 'eventing'],
      'eventing': ['eventing', 'jumping', 'dressage'],
      'liberty': ['liberty', 'groundwork'],
      'hobby / allround': ['hobby / allround', 'dressage', 'jumping', 'liberty'],
      'groundwork': ['groundwork', 'liberty'],
      'other': ['other']
    };

    if (buyerDiscipline === horseDiscipline) return 1.0;
    
    if (disciplineGroups[buyerDiscipline]?.includes(horseDiscipline)) {
      return 0.7;
    }
    
    return 0.3;
  },

  // üß© 3.8. –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
  colorMatch(buyerColor, horseColor) {
    if (!buyerColor || buyerColor === 'any') return 1.0;
    return buyerColor === horseColor ? 1.0 : 0.9;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
function convertHorseData(horse) {
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–æ–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  let horse_age;
  if (horse.age >= 3 && horse.age < 5) horse_age = '3‚Äì5';
  else if (horse.age >= 5 && horse.age < 7) horse_age = '5‚Äì7';
  else if (horse.age >= 7 && horse.age <= 10) horse_age = '7‚Äì10';
  else if (horse.age > 10 && horse.age <= 14) horse_age = '10‚Äì14';
  else if (horse.age > 14) horse_age = '14+';

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–æ–≤–æ–π —Ä–æ—Å—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  let horse_height;
  if (horse.height < 158) horse_height = '<158';
  else if (horse.height >= 158 && horse.height <= 165) horse_height = '158‚Äì165';
  else if (horse.height > 165 && horse.height <= 170) horse_height = '165‚Äì170';
  else if (horse.height > 170) horse_height = '170+';

  // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª–µ–π
  return {
    ...horse,
    // –§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    horse_age: horse_age,
    horse_height: horse_height,
    horse_sex: horse.sex,
    breed_type: horse.breed,
    budget: horse.price, // price -> budget
    coat_color: horse.color,
    
    // –î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    primary_discipline: horse.disciplines && horse.disciplines.length > 0 ? horse.disciplines[0] : 'other',
    training_level: horse.experience, // experience -> training_level
    
    // –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç
    temperament_boldness: horse.temperament, // temperament -> temperament_boldness
    sensitivity_level: horse.sensitivity, // sensitivity -> sensitivity_level
    pressure_response: horse.reaction, // reaction -> pressure_response
    reliability: horse.reliability,
    human_contact: horse.contact, // contact -> human_contact
    social_behavior: horse.dominance, // dominance -> social_behavior
    
    // –ê—Ç–ª–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    jumping_ability: horse.jumping_ability,
    dressage_relevance: horse.dressage_potential, // dressage_potential -> dressage_relevance
    
    // –ó–¥–æ—Ä–æ–≤—å–µ
    vet_status: horse.vet_status
  };
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
function computeMatch(buyer, horse) {
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ—à–∞–¥–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
  const convertedHorse = convertHorseData(horse);
  
  // üß© 3.1. –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –æ–ø—ã—Ç–∞
  if (buyer.experience_level && convertedHorse.training_level) {
    const isExpCompatible = compatibilityMatrices.checkExperienceCompatibility(
      buyer.experience_level, 
      convertedHorse.training_level
    );
    if (!isExpCompatible) {
      console.log(`–õ–æ—à–∞–¥—å ${horse.name} –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ —É—Ä–æ–≤–Ω—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: ${convertedHorse.training_level} –¥–ª—è –æ–ø—ã—Ç–∞ ${buyer.experience_level}`);
      return 0;
    }
  }

  // üß© 3.2. –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—é–¥–∂–µ—Ç–∞
  if (buyer.budget && convertedHorse.budget) {
    const isBudgetCompatible = compatibilityMatrices.checkBudgetCompatibility(
      buyer.budget, 
      convertedHorse.budget
    );
    if (!isBudgetCompatible) {
      console.log(`–õ–æ—à–∞–¥—å ${horse.name} –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ –±—é–¥–∂–µ—Ç—É: ${convertedHorse.budget} –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ ${buyer.budget}`);
      return 0;
    }
  }

  let totalScore = 0;
  let totalWeight = 0;

  // üß© 3.2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è target_subject
  const targetModifiers = compatibilityMatrices.calculateTargetSubjectModifiers(buyer.self, convertedHorse);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ —Å —É—á–µ—Ç–æ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
  const addCategoryScore = (category, buyerValue, horseValue, customMatchFn = null) => {
    if (!buyerValue || !horseValue) return;

    const weight = weights[category];
    let match = 0;

    if (customMatchFn) {
      match = customMatchFn(buyerValue, horseValue);
    } else {
      match = (buyerValue === horseValue) ? 1.0 : 0.0;
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã target_subject
    if (targetModifiers[category] !== undefined) {
      match *= targetModifiers[category];
    }

    totalScore += match * weight;
    totalWeight += weight;
  };

  // –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  addCategoryScore('primary_discipline', buyer.preferred_discipline, convertedHorse.primary_discipline, 
                   compatibilityMatrices.disciplineMatch);
  
  addCategoryScore('training_level', buyer.experience_level, convertedHorse.training_level);
  
  // –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
  addCategoryScore('reliability', buyer.self, convertedHorse.reliability);
  addCategoryScore('temperament_boldness', buyer.inner_role, convertedHorse.temperament_boldness);
  addCategoryScore('sensitivity_level', buyer.inner_role, convertedHorse.sensitivity_level);
  addCategoryScore('pressure_response', buyer.interaction_style, convertedHorse.pressure_response);
  addCategoryScore('human_contact', buyer.self, convertedHorse.human_contact);
  addCategoryScore('social_behavior', buyer.inner_role, convertedHorse.social_behavior);
  
  // –ê—Ç–ª–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
  addCategoryScore('jumping_ability', buyer.preferred_discipline, convertedHorse.jumping_ability);
  addCategoryScore('dressage_relevance', buyer.preferred_discipline, convertedHorse.dressage_relevance);
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  addCategoryScore('vet_status', buyer.self, convertedHorse.vet_status);
  addCategoryScore('coat_color', buyer.horse_color, convertedHorse.coat_color, compatibilityMatrices.colorMatch);
  
  // –ë—é–¥–∂–µ—Ç (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω —Å—Ç—Ä–æ–≥–æ)
  if (buyer.budget && convertedHorse.budget) {
    totalScore += 1.0 * weights.budget;
    totalWeight += weights.budget;
  }

  if (totalWeight === 0) return 0;

  // üß© 3.3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è —Å—Ç–∏–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  let interactionMultiplier = 1.0;
  if (buyer.interaction_style) {
    interactionMultiplier = compatibilityMatrices.getInteractionStyleMatch(buyer.interaction_style, convertedHorse);
  }

  const basePercentage = (totalScore / totalWeight) * 100;
  const finalPercentage = basePercentage * interactionMultiplier;

  return Math.min(Math.round(finalPercentage), 100);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
function getMatchLevel(percentage) {
  if (percentage >= 90) return { class: 'match-perfect', text: 'üíé –ò–î–ï–ê–õ–¨–ù–´–ô –ú–ê–¢–ß' };
  if (percentage >= 75) return { class: 'match-excellent', text: '‚≠ê –û–ß–ï–ù–¨ –•–û–†–û–®–ò–ô' };
  if (percentage >= 60) return { class: 'match-good', text: '‚úÖ –ü–û–î–•–û–î–Ø–©–ò–ô' };
  return { class: 'match-weak', text: '‚ö° –°–õ–ê–ë–´–ô –ú–ê–¢–ß' };
}

// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('buyerForm');
  const resultsDiv = document.getElementById('results');
  const searchBtn = document.getElementById('searchBtn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    searchBtn.disabled = true;
    searchBtn.textContent = 'üîÑ –ü–æ–∏—Å–∫...';
    resultsDiv.innerHTML = '<div class="loading">–ò–¥—ë—Ç –ø–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ª–æ—à–∞–¥–µ–π...</div>';

    try {
      // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
      const buyer = {
        self: document.getElementById('self').value,
        inner_role: document.getElementById('inner_role').value,
        experience_level: document.getElementById('experience_level').value,
        preferred_discipline: document.getElementById('preferred_discipline').value,
        interaction_style: document.getElementById('interaction_style').value,
        purchase_goal: document.getElementById('purchase_goal').value,
        horse_color: document.getElementById('horse_color').value,
        budget: document.getElementById('budget').value
      };

      console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:', buyer);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ—à–∞–¥–µ–π –∏–∑ Firebase
      const querySnapshot = await getDocs(collection(db, "horses"));
      const horses = [];
      
      querySnapshot.forEach((doc) => {
        horses.push({ id: doc.id, ...doc.data() });
      });

      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${horses.length} –ª–æ—à–∞–¥–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö`);

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ª–æ—à–∞–¥–∏
      const matches = horses.map(horse => {
        const score = computeMatch(buyer, horse);
        console.log(`–õ–æ—à–∞–¥—å ${horse.name}: ${score}%`, {
          training_level: horse.experience,
          budget: horse.price,
          discipline: horse.disciplines && horse.disciplines[0]
        });
        return { ...horse, score };
      })
      .filter(horse => horse.score > 0) // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö
      .sort((a, b) => b.score - a.score); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

      console.log(`–ù–∞–π–¥–µ–Ω–æ ${matches.length} –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ª–æ—à–∞–¥–µ–π`);

      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      if (matches.length === 0) {
        resultsDiv.innerHTML = `
          <div class="no-results">
            <p>üòî –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –ª–æ—à–∞–¥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –±—é–¥–∂–µ—Ç –∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</p>
          </div>
        `;
      } else {
        resultsDiv.innerHTML = `
          <h2>–ù–∞–π–¥–µ–Ω–æ –ª–æ—à–∞–¥–µ–π: ${matches.length}</h2>
          ${matches.map(horse => {
            const matchLevel = getMatchLevel(horse.score);
            const convertedHorse = convertHorseData(horse);
            
            return `
              <div class="horse-card">
                <div class="horse-header">
                  <div class="horse-name">${horse.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                  <div class="match-badge ${matchLevel.class}">
                    ${horse.score}% ‚Äî ${matchLevel.text}
                  </div>
                </div>
                <div class="horse-details">
                  <div class="detail-group">
                    <h4>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                    <p><strong>–ü–æ—Ä–æ–¥–∞:</strong> ${horse.breed || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> ${convertedHorse.horse_age || '–Ω–µ —É–∫–∞–∑–∞–Ω'} (${horse.age} –ª–µ—Ç)</p>
                    <p><strong>–†–æ—Å—Ç:</strong> ${convertedHorse.horse_height || '–Ω–µ —É–∫–∞–∑–∞–Ω'} (${horse.height} —Å–º)</p>
                    <p><strong>–ü–æ–ª:</strong> ${horse.sex || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                  </div>
                  <div class="detail-group">
                    <h4>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h4>
                    <p><strong>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:</strong> ${convertedHorse.primary_discipline || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${convertedHorse.training_level || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> ${convertedHorse.budget || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                  </div>
                  <div class="detail-group">
                    <h4>–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç</h4>
                    <p><strong>–•–∞—Ä–∞–∫—Ç–µ—Ä:</strong> ${convertedHorse.temperament_boldness || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:</strong> ${convertedHorse.reliability || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${convertedHorse.sensitivity_level || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${convertedHorse.human_contact || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        `;
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error);
      resultsDiv.innerHTML = `
        <div class="no-results">
          <p>‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ</p>
          <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</p>
          <p style="font-size: 0.9em; margin-top: 10px;">–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: ${error.message}</p>
        </div>
      `;
    } finally {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
      searchBtn.disabled = false;
      searchBtn.textContent = 'üîç –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ª–æ—à–∞–¥–µ–π';
    }
  });
});
</script>
</body>
</html>